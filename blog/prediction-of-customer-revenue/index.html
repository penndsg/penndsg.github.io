<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8"/>
  <title>prediction of customer revenue</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" title="Penn Data Science Group"
  href="http://penndsg.com/feed.xml">

  <!-- Customized Bootstrap + Font Awesome + Solarized -->
  <!-- Font Raleway from Google fonts -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:regular,bold" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet" media="screen">

  <link type="text/css" rel="stylesheet" href="/lightslider/css/lightslider.css" />
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/favicons/manifest.json">
  <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/favicons/favicon.ico">
  <meta name="msapplication-config" content="/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71898636-2', 'auto');
    ga('send', 'pageview');

  </script>
  <!-- END Google Analytics -->

  <!-- jQuery -->
  <script src="/js/jquery.min.js"></script>

  <!-- Bootstrap -->
  <script src="/js/transition.js"></script>
  <script src="/js/collapse.js"></script>

  <script src="/lightslider/js/lightslider.js"></script>

  <!-- Custom script to put footer at bottom even if post is short -->
  <!-- also controls color of footer logo on mouseover -->
  <script src="/js/footer.js"></script>

  <!-- Smooth Scrolling -->
  <script src="/js/smooth-scroll.min.js"></script>

  <!-- Math Rendering -->
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

</head>

<body>


  
  <div id="header">
  
    <div>
    
    <nav class="navbar navbar-default dark-bkg" role="navigation">
    
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-element" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">
            PDSG
          </a>
        </div>
        <div class="collapse navbar-collapse" id="navbar-collapse-element">
          <ul class="nav navbar-nav navbar-right">
            
            <li>
            
              <a href="/events/">Events</a>
            </li>
            
            <li>
            
              <a href="/gallery/">Gallery</a>
            </li>
            
            <li>
            
              <a href="/resources/">Resources</a>
            </li>
            
            <li>
            
              <a href="/members/">Members</a>
            </li>
            
            <li>
            
              <a href="/join/">Join</a>
            </li>
            
            <li>
            
              <a href="/collaborate/">Collaborate</a>
            </li>
            
            <li class="active">
            
              <a href="/blog/">Blog</a>
            </li>
            
            <li>
            
              <a href="/contact/">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </div>

  
  </div>

  <div id="content-wrapper">
    <div class="container blog-post">
  
  <div class="text-center">
    <h1>prediction of customer revenue</h1>
  </div>
  <hr>
  

  <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-10">
      
      
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
          
          
          
          
      <div class="row">
        
        <div class="col-md-12 text-center" >
          <a class="off" href="/members/levani-zandarashvili/">
            <img src="/images/members/levani-zandarashvili.jpg" class="img-thumbnail" style="width: 150px;">
          </a>
        </div>
        
        <div class="col-md-12 text-center">
          <a class="off" href="/members/levani-zandarashvili/">
            <h4>Levani Zandarashvili</h4>
          </a>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="post">
        <h3 id="predict-future-sales">Predict Future Sales</h3>
<p>This notebook is based on the data provided in the Kaggle competition “Google Analytics Customer Revenue Prediction”.
https://www.kaggle.com/c/ga-customer-revenue-prediction.</p>

<p>The tast was done as part of Penn Data Science Group Kaggle team.
http://penndsg.com/.</p>

<p>In this notebook, I trained the model in two steps. In the first step, I used LightGBM classified to predict probabilities of making a purchase for each row. In the second step, I “filtered out” the rows with very low probability of purchase and trained the LightGBM regression model on the remaining data. Since majority of purchases in GStore are made by the small group of customers, such two-step process will allow us to filter out the non-purchasing customers and let us focus on the purchasing customers during the regression model training.</p>

<p>This notebook goes through the following steps to make a final prediction of a future revenue for each customer based on the provided data.</p>
<ul>
  <li>Load data from csv files</li>
  <li>Convert json format features into individual columns</li>
  <li>Exclude unnecessary features</li>
  <li>Visualize data</li>
  <li>Create new features</li>
  <li>Prepare data for model training</li>
  <li>Perform classification using LGBMClassifier combined with grid search</li>
  <li>Filter out the low probability rows</li>
  <li>Perform regression using LGBMRegression combined with grid search</li>
  <li>Make prediction for the test data</li>
  <li>Save test data prediction into csv file</li>
  <li>Discussion: Future steps to improve this model</li>
</ul>

<h3 id="import-some-crucial-libraries">Import some crucial libraries</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.max_columns'</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="n">lgb</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pandas.io.json</span> <span class="kn">import</span> <span class="n">json_normalize</span>
<span class="kn">import</span> <span class="nn">datetime</span>
</code></pre></div></div>

<h3 id="loading-the-test-and-training-data">Loading the test and training data.</h3>
<p>Some of the features are present in json format. We need to expand them in order to use in calculation. The following function does exactly that.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_df</span><span class="p">(</span><span class="n">csv_path</span><span class="o">=</span><span class="s">'train.csv'</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">JSON_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'device'</span><span class="p">,</span> <span class="s">'geoNetwork'</span><span class="p">,</span> <span class="s">'totals'</span><span class="p">,</span> <span class="s">'trafficSource'</span><span class="p">]</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> 
                     <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="n">column</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">JSON_COLUMNS</span><span class="p">},</span> 
                     <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s">'fullVisitorId'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">},</span> <span class="c1"># Important!!
</span>                     <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">JSON_COLUMNS</span><span class="p">:</span>
        <span class="n">column_as_df</span> <span class="o">=</span> <span class="n">json_normalize</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        <span class="n">column_as_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s">"{column}.{subcolumn}"</span> <span class="k">for</span> <span class="n">subcolumn</span> <span class="ow">in</span> <span class="n">column_as_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">column_as_df</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Loaded {os.path.basename(csv_path)}. Shape: {df.shape}"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># expand the test and train data as pandas dataframes
# this step takes ~5 minutes on my laptop, so instead I created a separate file where I ran these steps once and 
# saved the outputs into csv files, so that I don't have to repeate this step every single time.
# uncomment the lines below when running for the first time
</span>
<span class="c1">#%%time
#train_df = load_df()
#test_df = load_df("test.csv")
</span>
<span class="c1">#train_df.to_csv('train_expanded.csv')
#test_df.to_csv('test_expanded.csv')
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load data with expanded json features from files created using the code above
</span><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'train_v2_expanded.csv'</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s">'fullVisitorId'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">})</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'test_v2_expanded.csv'</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s">'fullVisitorId'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="check-columns-with-a-single-unique-value-if-there-is-at-least-one-value-and-a-nan-value-then-well-keep-such-features-absence-of-a-value-nan-value-is-itself-informative">Check columns with a single unique value. If there is at least one value and a nan value, then we’ll keep such features. Absence of a value (nan value) is itself informative.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">constant_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">train_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="n">dropna</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">constant_columns</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['socialEngagementType',
 'device.browserSize',
 'device.browserVersion',
 'device.flashVersion',
 'device.language',
 'device.mobileDeviceBranding',
 'device.mobileDeviceInfo',
 'device.mobileDeviceMarketingName',
 'device.mobileDeviceModel',
 'device.mobileInputSelector',
 'device.operatingSystemVersion',
 'device.screenColors',
 'device.screenResolution',
 'geoNetwork.cityId',
 'geoNetwork.latitude',
 'geoNetwork.longitude',
 'geoNetwork.networkLocation',
 'totals.visits',
 'trafficSource.adwordsClickInfo.criteriaParameters']
</code></pre></div></div>

<h3 id="exclude-some-uselessextra-features">Exclude some useless/extra features.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># features with constant values should be excluded, since they don't carry any useful information.
</span><span class="n">columns_to_exclude</span> <span class="o">=</span> <span class="n">constant_columns</span>

<span class="c1"># in addition, I will also exclude 'sessionId' feature, since it carries no useful information and 'Unnamed: 0',
# since it is an artifact I created when I expanded json features.
# columns_to_exclude = columns_to_exclude + ['sessionId']
</span><span class="n">columns_to_exclude</span> <span class="o">=</span> <span class="n">columns_to_exclude</span>

<span class="c1"># I'll remove these features from both test and training data.
</span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_to_exclude</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns_to_exclude</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="at-this-point-test-and-training-data-should-have-identical-set-of-features-with-a-single-exception-of-the-training-feature-y-lets-see-it-is-true">At this point test and training data should have identical set of features, with a single exception of the training feature (y). let’s see it is true.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'trafficSource.campaignCode'}
</code></pre></div></div>

<h3 id="as-we-can-see-the-training-data-has-two-additional-features-totalstransactionrevenue-is-the-training-feature-so-it-should-stay-but-the-trafficsourcecampaigncode-is-unique-for-only-the-training-data-so-it-has-to-be-removed">As we can see, the training data has two additional features. ‘totals.transactionRevenue’ is the training feature, so it should stay, but the ‘trafficSource.campaignCode’ is unique for only the training data, so it has to be removed.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s">'trafficSource.campaignCode'</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>done
</code></pre></div></div>

<h3 id="at-this-pointlets-look-at-the-features-in-more-details">At this point,let’s look at the features in more details.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_df</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(401589, 39)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>channelGrouping</th>
      <th>customDimensions</th>
      <th>date</th>
      <th>fullVisitorId</th>
      <th>visitId</th>
      <th>visitNumber</th>
      <th>visitStartTime</th>
      <th>device.browser</th>
      <th>device.deviceCategory</th>
      <th>device.isMobile</th>
      <th>device.operatingSystem</th>
      <th>geoNetwork.city</th>
      <th>geoNetwork.continent</th>
      <th>geoNetwork.country</th>
      <th>geoNetwork.metro</th>
      <th>geoNetwork.networkDomain</th>
      <th>geoNetwork.region</th>
      <th>geoNetwork.subContinent</th>
      <th>totals.bounces</th>
      <th>totals.hits</th>
      <th>totals.newVisits</th>
      <th>totals.pageviews</th>
      <th>totals.sessionQualityDim</th>
      <th>totals.timeOnSite</th>
      <th>totals.totalTransactionRevenue</th>
      <th>totals.transactionRevenue</th>
      <th>totals.transactions</th>
      <th>trafficSource.adContent</th>
      <th>trafficSource.adwordsClickInfo.adNetworkType</th>
      <th>trafficSource.adwordsClickInfo.gclId</th>
      <th>trafficSource.adwordsClickInfo.isVideoAd</th>
      <th>trafficSource.adwordsClickInfo.page</th>
      <th>trafficSource.adwordsClickInfo.slot</th>
      <th>trafficSource.campaign</th>
      <th>trafficSource.isTrueDirect</th>
      <th>trafficSource.keyword</th>
      <th>trafficSource.medium</th>
      <th>trafficSource.referralPath</th>
      <th>trafficSource.source</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Organic Search</td>
      <td>[{'index': '4', 'value': 'EMEA'}]</td>
      <td>20171016</td>
      <td>3162355547410993243</td>
      <td>1508198450</td>
      <td>1</td>
      <td>1508198450</td>
      <td>Firefox</td>
      <td>desktop</td>
      <td>False</td>
      <td>Windows</td>
      <td>not available in demo dataset</td>
      <td>Europe</td>
      <td>Germany</td>
      <td>not available in demo dataset</td>
      <td>(not set)</td>
      <td>not available in demo dataset</td>
      <td>Western Europe</td>
      <td>1.0</td>
      <td>1</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>(not set)</td>
      <td>NaN</td>
      <td>water bottle</td>
      <td>organic</td>
      <td>NaN</td>
      <td>google</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Referral</td>
      <td>[{'index': '4', 'value': 'North America'}]</td>
      <td>20171016</td>
      <td>8934116514970143966</td>
      <td>1508176307</td>
      <td>6</td>
      <td>1508176307</td>
      <td>Chrome</td>
      <td>desktop</td>
      <td>False</td>
      <td>Chrome OS</td>
      <td>Cupertino</td>
      <td>Americas</td>
      <td>United States</td>
      <td>San Francisco-Oakland-San Jose CA</td>
      <td>(not set)</td>
      <td>California</td>
      <td>Northern America</td>
      <td>NaN</td>
      <td>2</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>28.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>(not set)</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>referral</td>
      <td>/a/google.com/transportation/mtv-services/bike...</td>
      <td>sites.google.com</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Direct</td>
      <td>[{'index': '4', 'value': 'North America'}]</td>
      <td>20171016</td>
      <td>7992466427990357681</td>
      <td>1508201613</td>
      <td>1</td>
      <td>1508201613</td>
      <td>Chrome</td>
      <td>mobile</td>
      <td>True</td>
      <td>Android</td>
      <td>not available in demo dataset</td>
      <td>Americas</td>
      <td>United States</td>
      <td>not available in demo dataset</td>
      <td>windjammercable.net</td>
      <td>not available in demo dataset</td>
      <td>Northern America</td>
      <td>NaN</td>
      <td>2</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>38.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>(not set)</td>
      <td>True</td>
      <td>NaN</td>
      <td>(none)</td>
      <td>NaN</td>
      <td>(direct)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Organic Search</td>
      <td>[{'index': '4', 'value': 'EMEA'}]</td>
      <td>20171016</td>
      <td>9075655783635761930</td>
      <td>1508169851</td>
      <td>1</td>
      <td>1508169851</td>
      <td>Chrome</td>
      <td>desktop</td>
      <td>False</td>
      <td>Windows</td>
      <td>not available in demo dataset</td>
      <td>Asia</td>
      <td>Turkey</td>
      <td>not available in demo dataset</td>
      <td>unknown.unknown</td>
      <td>not available in demo dataset</td>
      <td>Western Asia</td>
      <td>NaN</td>
      <td>2</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>(not set)</td>
      <td>NaN</td>
      <td>(not provided)</td>
      <td>organic</td>
      <td>NaN</td>
      <td>google</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Organic Search</td>
      <td>[{'index': '4', 'value': 'Central America'}]</td>
      <td>20171016</td>
      <td>6960673291025684308</td>
      <td>1508190552</td>
      <td>1</td>
      <td>1508190552</td>
      <td>Chrome</td>
      <td>desktop</td>
      <td>False</td>
      <td>Windows</td>
      <td>not available in demo dataset</td>
      <td>Americas</td>
      <td>Mexico</td>
      <td>not available in demo dataset</td>
      <td>prod-infinitum.com.mx</td>
      <td>not available in demo dataset</td>
      <td>Central America</td>
      <td>NaN</td>
      <td>2</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>52.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>(not set)</td>
      <td>NaN</td>
      <td>(not provided)</td>
      <td>organic</td>
      <td>NaN</td>
      <td>google</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="categorical-features">Categorical features.</h3>
<p>Let’s look at some categorical features in more details.</p>

<p>At first, let’s go through the categorical features one by one and use the groupby function to see the total revenues, mean revenues and counts of non-zero transaction.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define a function to group by a certain feature, aggregate total revenue sum, mean and count and show the head of
# resulting dataframe (sorted)
</span><span class="k">def</span> <span class="nf">describe_function</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col</span><span class="p">)[</span><span class="s">'totals.transactionRevenue'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'sum'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">,</span><span class="s">'count'</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">"count"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s">"channelGrouping"</span><span class="p">,</span> <span class="s">"device.browser"</span><span class="p">,</span> 
            <span class="s">"device.deviceCategory"</span><span class="p">,</span> <span class="s">"device.operatingSystem"</span><span class="p">,</span> 
            <span class="s">"geoNetwork.city"</span><span class="p">,</span> <span class="s">"geoNetwork.continent"</span><span class="p">,</span> 
            <span class="s">"geoNetwork.country"</span><span class="p">,</span> <span class="s">"geoNetwork.metro"</span><span class="p">,</span>
            <span class="s">"geoNetwork.networkDomain"</span><span class="p">,</span> <span class="s">"geoNetwork.region"</span><span class="p">,</span> 
            <span class="s">"geoNetwork.subContinent"</span><span class="p">,</span> <span class="s">"trafficSource.adContent"</span><span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
    <span class="n">describe_function</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>channelGrouping</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Referral</th>
      <td>9.960210e+11</td>
      <td>1.160052e+08</td>
      <td>8586</td>
    </tr>
    <tr>
      <th>Organic Search</th>
      <td>5.394990e+11</td>
      <td>9.785941e+07</td>
      <td>5513</td>
    </tr>
    <tr>
      <th>Direct</th>
      <td>5.973243e+11</td>
      <td>1.799170e+08</td>
      <td>3320</td>
    </tr>
    <tr>
      <th>Paid Search</th>
      <td>6.696862e+10</td>
      <td>9.418934e+07</td>
      <td>711</td>
    </tr>
    <tr>
      <th>Display</th>
      <td>1.082893e+11</td>
      <td>5.282403e+08</td>
      <td>205</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>device.browser</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Chrome</th>
      <td>2.068165e+12</td>
      <td>1.238645e+08</td>
      <td>16697</td>
    </tr>
    <tr>
      <th>Safari</th>
      <td>7.670099e+10</td>
      <td>6.338925e+07</td>
      <td>1210</td>
    </tr>
    <tr>
      <th>Firefox</th>
      <td>1.502462e+11</td>
      <td>4.432043e+08</td>
      <td>339</td>
    </tr>
    <tr>
      <th>Internet Explorer</th>
      <td>1.195796e+10</td>
      <td>8.079703e+07</td>
      <td>148</td>
    </tr>
    <tr>
      <th>Edge</th>
      <td>8.067300e+09</td>
      <td>1.090176e+08</td>
      <td>74</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>device.deviceCategory</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>desktop</th>
      <td>2.229097e+12</td>
      <td>1.318602e+08</td>
      <td>16905</td>
    </tr>
    <tr>
      <th>mobile</th>
      <td>7.429866e+10</td>
      <td>5.447116e+07</td>
      <td>1364</td>
    </tr>
    <tr>
      <th>tablet</th>
      <td>1.294908e+10</td>
      <td>5.285339e+07</td>
      <td>245</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>device.operatingSystem</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Macintosh</th>
      <td>1.315231e+12</td>
      <td>1.270264e+08</td>
      <td>10354</td>
    </tr>
    <tr>
      <th>Windows</th>
      <td>5.750670e+11</td>
      <td>1.610381e+08</td>
      <td>3571</td>
    </tr>
    <tr>
      <th>Chrome OS</th>
      <td>2.696522e+11</td>
      <td>1.583395e+08</td>
      <td>1703</td>
    </tr>
    <tr>
      <th>Linux</th>
      <td>7.025809e+10</td>
      <td>5.404468e+07</td>
      <td>1300</td>
    </tr>
    <tr>
      <th>iOS</th>
      <td>3.588012e+10</td>
      <td>4.312514e+07</td>
      <td>832</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.city</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>not available in demo dataset</th>
      <td>9.397274e+11</td>
      <td>1.320213e+08</td>
      <td>7118</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>3.258931e+11</td>
      <td>1.357322e+08</td>
      <td>2401</td>
    </tr>
    <tr>
      <th>Mountain View</th>
      <td>2.035964e+11</td>
      <td>9.854617e+07</td>
      <td>2066</td>
    </tr>
    <tr>
      <th>San Francisco</th>
      <td>1.429065e+11</td>
      <td>1.255769e+08</td>
      <td>1138</td>
    </tr>
    <tr>
      <th>Sunnyvale</th>
      <td>6.908219e+10</td>
      <td>8.146485e+07</td>
      <td>848</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.continent</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Americas</th>
      <td>2.265098e+12</td>
      <td>1.247988e+08</td>
      <td>18150</td>
    </tr>
    <tr>
      <th>Asia</th>
      <td>2.339772e+10</td>
      <td>1.231459e+08</td>
      <td>190</td>
    </tr>
    <tr>
      <th>Europe</th>
      <td>1.124745e+10</td>
      <td>8.926548e+07</td>
      <td>126</td>
    </tr>
    <tr>
      <th>Oceania</th>
      <td>6.781100e+09</td>
      <td>2.338310e+08</td>
      <td>29</td>
    </tr>
    <tr>
      <th>Africa</th>
      <td>9.025990e+09</td>
      <td>7.521658e+08</td>
      <td>12</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.country</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>United States</th>
      <td>2.197885e+12</td>
      <td>1.244697e+08</td>
      <td>17658</td>
    </tr>
    <tr>
      <th>Canada</th>
      <td>4.269923e+10</td>
      <td>1.355531e+08</td>
      <td>315</td>
    </tr>
    <tr>
      <th>Venezuela</th>
      <td>1.390126e+10</td>
      <td>2.044303e+08</td>
      <td>68</td>
    </tr>
    <tr>
      <th>Taiwan</th>
      <td>2.934200e+09</td>
      <td>9.169375e+07</td>
      <td>32</td>
    </tr>
    <tr>
      <th>Mexico</th>
      <td>3.763080e+09</td>
      <td>1.393733e+08</td>
      <td>27</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.metro</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>not available in demo dataset</th>
      <td>9.397274e+11</td>
      <td>1.320213e+08</td>
      <td>7118</td>
    </tr>
    <tr>
      <th>San Francisco-Oakland-San Jose CA</th>
      <td>5.062230e+11</td>
      <td>1.015696e+08</td>
      <td>4984</td>
    </tr>
    <tr>
      <th>New York NY</th>
      <td>3.274385e+11</td>
      <td>1.351376e+08</td>
      <td>2423</td>
    </tr>
    <tr>
      <th>Chicago IL</th>
      <td>1.104102e+11</td>
      <td>1.665313e+08</td>
      <td>663</td>
    </tr>
    <tr>
      <th>Los Angeles CA</th>
      <td>9.190494e+10</td>
      <td>1.598347e+08</td>
      <td>575</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.networkDomain</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(not set)</th>
      <td>1.305843e+12</td>
      <td>1.201659e+08</td>
      <td>10867</td>
    </tr>
    <tr>
      <th>comcast.net</th>
      <td>1.773147e+11</td>
      <td>1.178171e+08</td>
      <td>1505</td>
    </tr>
    <tr>
      <th>verizon.net</th>
      <td>7.967340e+10</td>
      <td>1.055277e+08</td>
      <td>755</td>
    </tr>
    <tr>
      <th>unknown.unknown</th>
      <td>5.825398e+10</td>
      <td>8.759997e+07</td>
      <td>665</td>
    </tr>
    <tr>
      <th>rr.com</th>
      <td>5.322676e+10</td>
      <td>9.052170e+07</td>
      <td>588</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.region</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>not available in demo dataset</th>
      <td>9.397274e+11</td>
      <td>1.320213e+08</td>
      <td>7118</td>
    </tr>
    <tr>
      <th>California</th>
      <td>6.091657e+11</td>
      <td>1.079124e+08</td>
      <td>5645</td>
    </tr>
    <tr>
      <th>New York</th>
      <td>3.262089e+11</td>
      <td>1.357507e+08</td>
      <td>2403</td>
    </tr>
    <tr>
      <th>Illinois</th>
      <td>1.104102e+11</td>
      <td>1.665313e+08</td>
      <td>663</td>
    </tr>
    <tr>
      <th>Washington</th>
      <td>4.921693e+10</td>
      <td>9.612682e+07</td>
      <td>512</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>geoNetwork.subContinent</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Northern America</th>
      <td>2.240584e+12</td>
      <td>1.246639e+08</td>
      <td>17973</td>
    </tr>
    <tr>
      <th>South America</th>
      <td>1.855388e+10</td>
      <td>1.520810e+08</td>
      <td>122</td>
    </tr>
    <tr>
      <th>Eastern Asia</th>
      <td>1.399618e+10</td>
      <td>1.686287e+08</td>
      <td>83</td>
    </tr>
    <tr>
      <th>Southeast Asia</th>
      <td>6.019380e+09</td>
      <td>1.020234e+08</td>
      <td>59</td>
    </tr>
    <tr>
      <th>Western Europe</th>
      <td>4.259950e+09</td>
      <td>8.874896e+07</td>
      <td>48</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>count</th>
    </tr>
    <tr>
      <th>trafficSource.adContent</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Google Merchandise Collection</th>
      <td>2.064188e+10</td>
      <td>1.358018e+08</td>
      <td>152</td>
    </tr>
    <tr>
      <th>Official Google Merchandise</th>
      <td>1.719470e+09</td>
      <td>6.877880e+07</td>
      <td>25</td>
    </tr>
    <tr>
      <th>Display Ad created 3/11/14</th>
      <td>5.697200e+08</td>
      <td>6.330222e+07</td>
      <td>9</td>
    </tr>
    <tr>
      <th>Google Online Store</th>
      <td>2.109800e+08</td>
      <td>3.516333e+07</td>
      <td>6</td>
    </tr>
    <tr>
      <th>Placement Accessores 300 x 250</th>
      <td>5.771900e+08</td>
      <td>1.154380e+08</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>

<p>As we can see, using tables to visualize our data is very tricky, so next, I will draw the graphs instead.
For each of the following features, I calculated the sum and count of transactionRevenue and sorted in descending order (based on count) before plotting.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#temp_df = train_df.groupby('geoNetwork.continent')['totals.transactionRevenue'].agg(['sum', 'count']).sort_values(by="count", ascending=False).head(10)
</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'font.size'</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">85</span><span class="p">))</span>
<span class="c1"># sns.barplot(y=temp_df.index, x=temp_df['sum'], ax = axes[0,0])
# sns.barplot(y=temp_df.index, x=temp_df['count'], ax = axes[0,1])
</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)):</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col</span><span class="p">)[</span><span class="s">'totals.transactionRevenue'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'sum'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s">"count"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># Some names were too long, so I shortened them to just 10 characters
</span>    <span class="n">y_temp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">temp_df</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y_temp</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">temp_df</span><span class="p">[</span><span class="s">'sum'</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y_temp</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">temp_df</span><span class="p">[</span><span class="s">'count'</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s">': sum'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s">': count'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
    <span class="c1">#axes[n,0].tick_params(labelsize=20)
</span>    <span class="c1">#axes[n,1].tick_params(labelsize=20)
</span></code></pre></div></div>

<p><img src="images/blog/prediction_of_customer_revenue_21_0.png" alt="png" /></p>

<p>As you can see, while there is some strong imbalance for some features (e.g. continent, country, etc.), there is a quite good variation in some other features (e.g. region, metro, city, etc.). Such variation is very useful when training models.</p>

<h3 id="visitstarttime-column-contains-the-same-information-as-date-so-it-can-be-replaced-ill-also-generate-features-for-the-day-of-the-week-hour-month-and-day-of-the-month-i-will-also-generate-features-for-the-difference-between-next-and-previous-visit-sessions-for-both-test-and-train-datasets">“visitStartTime” column contains the same information as “date”, so it can be replaced. I’ll also generate features for the day of the week, hour, month and day of the month. I will also generate features for the difference between next and previous visit sessions for both test and train datasets.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s">'visitStartTime'</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">'s'</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">[</span><span class="s">'day_of_week'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span>
<span class="n">train_df</span><span class="p">[</span><span class="s">'hour'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
<span class="n">train_df</span><span class="p">[</span><span class="s">'day_of_month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
<span class="n">train_df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

<span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s">'visitStartTime'</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">'s'</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'day_of_week'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'hour'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'day_of_month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

<span class="n">train_df</span><span class="p">[</span><span class="s">'next_session_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">-</span> <span class="n">train_df</span><span class="p">[[</span><span class="s">'fullVisitorId'</span><span class="p">,</span> <span class="s">'date'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'fullVisitorId'</span><span class="p">)[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">//</span> <span class="mf">1e9</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">//</span> <span class="mi">60</span>

<span class="n">train_df</span><span class="p">[</span><span class="s">'next_session_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">train_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">-</span> <span class="n">train_df</span><span class="p">[[</span><span class="s">'fullVisitorId'</span><span class="p">,</span> <span class="s">'date'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'fullVisitorId'</span><span class="p">)[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">//</span> <span class="mf">1e9</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">//</span> <span class="mi">60</span>

<span class="n">test_df</span><span class="p">[</span><span class="s">'next_session_1'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">-</span> <span class="n">test_df</span><span class="p">[[</span><span class="s">'fullVisitorId'</span><span class="p">,</span> <span class="s">'date'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'fullVisitorId'</span><span class="p">)[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">//</span> <span class="mf">1e9</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">//</span> <span class="mi">60</span>

<span class="n">test_df</span><span class="p">[</span><span class="s">'next_session_2'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">test_df</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">-</span> <span class="n">test_df</span><span class="p">[[</span><span class="s">'fullVisitorId'</span><span class="p">,</span> <span class="s">'date'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'fullVisitorId'</span><span class="p">)[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">//</span> <span class="mf">1e9</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">//</span> <span class="mi">60</span>

<span class="c1"># delete the "date" feature
</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'date'</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'date'</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>done
</code></pre></div></div>

<h3 id="impute-0-for-missing-target-values-no-need-to-do-this-for-other-features-since-lightgbm-can-deal-with-them-on-its-own">Impute 0 for missing target values. No need to do this for other features since LightGBM can deal with them on its own.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span><span class="p">[</span><span class="s">"totals.transactionRevenue"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># test_id will be used in the end when generating the submission file.
</span><span class="n">test_id</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">"fullVisitorId"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></div>

<h3 id="label-encode-the-categorical-variables-and-convert-the-numerical-variables-to-float">label encode the categorical variables and convert the numerical variables to float</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># define the categorical features
</span><span class="n">cat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">"channelGrouping"</span><span class="p">,</span> <span class="s">"device.browser"</span><span class="p">,</span> 
            <span class="s">"device.deviceCategory"</span><span class="p">,</span> <span class="s">"device.operatingSystem"</span><span class="p">,</span> 
            <span class="s">"geoNetwork.city"</span><span class="p">,</span> <span class="s">"geoNetwork.continent"</span><span class="p">,</span> 
            <span class="s">"geoNetwork.country"</span><span class="p">,</span> <span class="s">"geoNetwork.metro"</span><span class="p">,</span>
            <span class="s">"geoNetwork.networkDomain"</span><span class="p">,</span> <span class="s">"geoNetwork.region"</span><span class="p">,</span> 
            <span class="s">"geoNetwork.subContinent"</span><span class="p">,</span> <span class="s">"trafficSource.adContent"</span><span class="p">,</span> 
            <span class="s">"trafficSource.adwordsClickInfo.adNetworkType"</span><span class="p">,</span> 
            <span class="s">"trafficSource.adwordsClickInfo.gclId"</span><span class="p">,</span> 
            <span class="s">"trafficSource.adwordsClickInfo.page"</span><span class="p">,</span> 
            <span class="s">"trafficSource.adwordsClickInfo.slot"</span><span class="p">,</span> <span class="s">"trafficSource.campaign"</span><span class="p">,</span>
            <span class="s">"trafficSource.keyword"</span><span class="p">,</span> <span class="s">"trafficSource.medium"</span><span class="p">,</span> 
            <span class="s">"trafficSource.referralPath"</span><span class="p">,</span> <span class="s">"trafficSource.source"</span><span class="p">,</span>
            <span class="s">'trafficSource.adwordsClickInfo.isVideoAd'</span><span class="p">,</span> <span class="s">'trafficSource.isTrueDirect'</span><span class="p">,</span>
            <span class="s">'day_of_week'</span><span class="p">,</span> <span class="s">'hour'</span><span class="p">,</span> <span class="s">'day_of_month'</span><span class="p">,</span> <span class="s">'month'</span><span class="p">]</span>

<span class="c1"># label encode the categorical features
</span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cat_cols</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">lbl</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span>
    <span class="n">lbl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'str'</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'str'</span><span class="p">)))</span>
    <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'str'</span><span class="p">)))</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbl</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'str'</span><span class="p">)))</span>

<span class="c1"># define categorical values as 'categorical'. Might be a bit redundant, but I want to make sure that they are defined as such.
</span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_cols</span><span class="p">:</span>
    <span class="n">train_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
        

<span class="c1"># make sure that the numerical columns are float type
</span><span class="n">num_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">"totals.hits"</span><span class="p">,</span> <span class="s">"totals.pageviews"</span><span class="p">,</span> <span class="s">"visitNumber"</span><span class="p">,</span> <span class="s">"visitStartTime"</span><span class="p">,</span> <span class="s">'totals.bounces'</span><span class="p">,</span>  <span class="s">'totals.newVisits'</span><span class="p">,</span> <span class="s">'next_session_1'</span><span class="p">,</span> <span class="s">'next_session_2'</span><span class="p">]</span>    
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">num_cols</span><span class="p">:</span>
    <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>channelGrouping
device.browser
device.deviceCategory
device.operatingSystem
geoNetwork.city
geoNetwork.continent
geoNetwork.country
geoNetwork.metro
geoNetwork.networkDomain
geoNetwork.region
geoNetwork.subContinent
trafficSource.adContent
trafficSource.adwordsClickInfo.adNetworkType
trafficSource.adwordsClickInfo.gclId
trafficSource.adwordsClickInfo.page
trafficSource.adwordsClickInfo.slot
trafficSource.campaign
trafficSource.keyword
trafficSource.medium
trafficSource.referralPath
trafficSource.source
trafficSource.adwordsClickInfo.isVideoAd
trafficSource.isTrueDirect
day_of_week
hour
day_of_month
month
done
</code></pre></div></div>

<h3 id="i-am-going-to-first-perform-a-classification-task-where-i-will-classify-the-rows-based-on-the-probability-of-a-purchase-regardless-of-an-exact-value-of-the-purchase">I am going to first perform a classification task where I will classify the rows based on the probability of a purchase, regardless of an exact value of the purchase.</h3>
<p>Majority of visits don’t result in a purchase and performing such classification first might help us remove the instances of visits with very low probability of visit. For this purpose, I will identify the visitors based on their ‘fullVisitorId’ and see if they have ever made even a single purchase. Then I will add a new identifier ‘purchasing_customer’ to each row. 0 if this customer has never made a purchase and 1 if they have. Then I will use this feature for the classification task. Next, I will have to use the results of the classification to predict the feature for the test set (since we don’t know who makes a purchase in the test set).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># calculate the total revenue per visitor. I'll use this later to see if a visitor has ever made a purchase
</span><span class="n">total_purchase_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[[</span><span class="s">'fullVisitorId'</span><span class="p">,</span><span class="s">'totals.transactionRevenue'</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'fullVisitorId'</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">total_purchase_df</span> <span class="o">=</span> <span class="n">total_purchase_df</span><span class="p">[</span><span class="s">'totals.transactionRevenue'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create a feature purchasing_customer.
# 1 indicates that the visitor has made a purchase at least once. 0 indicates no purchase ever.
</span><span class="n">train_df</span><span class="p">[</span><span class="s">'purchasing_customer'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">"fullVisitorId"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">total_purchase_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"there are "</span><span class="p">,</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'purchasing_customer'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">(),</span> <span class="s">"entres for customers who made a purchase at some point"</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>there are  61319 entres for customers who made a purchase at some point
</code></pre></div></div>

<h3 id="define-the-parameters-for-the-grid-search-for-classification-task">Define the parameters for the grid search for classification task.</h3>
<p>Parameters for grid search and the fixed parameters need to be in separate dictionaries. For the parameters for which I already performed the grid search, I will put the tested options next to them as comments so that I don’t need to test them again.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set fixed params
</span><span class="n">params_classification</span> <span class="o">=</span> <span class="p">{</span><span class="c1">#"objective" : "regression",
</span>        <span class="s">"metric"</span> <span class="p">:</span> <span class="s">"rmse"</span><span class="p">,</span>
        <span class="s">'max_depth'</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">'max_bin'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
        <span class="s">"min_child_samples"</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s">"bagging_fraction"</span> <span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="s">"feature_fraction"</span> <span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s">"bagging_frequency"</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">"bagging_seed"</span> <span class="p">:</span> <span class="mi">2018</span><span class="p">,</span>
        <span class="s">"verbosity"</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

<span class="c1"># Create parameters to search
</span><span class="n">gridParams_classification</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'learning_rate'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="c1">#0.1, 0.05, 0.2
</span>    <span class="s">'n_estimators'</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="c1"># 70, 50
</span>    <span class="s">'num_leaves'</span><span class="p">:</span> <span class="p">[</span><span class="mi">70</span><span class="p">],</span> <span class="c1"># 30, 50
</span>    <span class="s">'colsample_bytree'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">],</span> <span class="c1"># 0.1, 1
</span>    <span class="s">'subsample'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">],</span> <span class="c1"># 0.1, 1
</span>    <span class="s">'reg_alpha'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">],</span> <span class="c1"># 1, 1.2
</span>    <span class="s">'reg_lambda'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># 1.2, 1.4
</span>    <span class="p">}</span>
</code></pre></div></div>

<h3 id="create-training-dataframes-of-course-the-totalstransactionrevenue-will-be-excluded-since-it-is-not-present-in-the-test-set">create training dataframes. Of course, the ‘totals.transactionRevenue’ will be excluded, since it is not present in the test set.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X_train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">cat_cols</span> <span class="o">+</span> <span class="n">num_cols</span><span class="p">]</span>
<span class="n">y_train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'purchasing_customer'</span><span class="p">]</span>

<span class="c1"># X_test_df will be used to predict the 'purchasing_customer' feature for the test set.
</span><span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">cat_cols</span> <span class="o">+</span> <span class="n">num_cols</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="create-the-classifier-and-perform-classification-task">Create the classifier and perform classification task.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create classifier to use. Note that parameters have to be input manually, not as a dict!
</span>
<span class="n">mdl_classifier</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span>
          <span class="n">objective</span> <span class="o">=</span> <span class="s">'binary'</span><span class="p">,</span>
          <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
          <span class="n">silent</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
          <span class="n">max_depth</span> <span class="o">=</span> <span class="n">params_classification</span><span class="p">[</span><span class="s">'max_depth'</span><span class="p">],</span>
          <span class="n">max_bin</span> <span class="o">=</span> <span class="n">params_classification</span><span class="p">[</span><span class="s">'max_bin'</span><span class="p">],</span>
          <span class="n">feature_fraction</span> <span class="o">=</span> <span class="n">params_classification</span><span class="p">[</span><span class="s">'feature_fraction'</span><span class="p">],</span>
          <span class="n">min_child_samples</span> <span class="o">=</span> <span class="n">params_classification</span><span class="p">[</span><span class="s">'min_child_samples'</span><span class="p">],</span>
          <span class="n">bagging_fraction</span> <span class="o">=</span> <span class="n">params_classification</span><span class="p">[</span><span class="s">'bagging_fraction'</span><span class="p">]</span>
          <span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create the grid search with 4 fold cross validation
</span><span class="n">grid_classification</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">mdl_classifier</span><span class="p">,</span> <span class="n">gridParams_classification</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">n_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Run the grid
</span><span class="n">grid_classification</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">)</span>

<span class="c1"># Print the best parameters found
</span><span class="k">print</span><span class="p">(</span><span class="n">grid_classification</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">grid_classification</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'colsample_bytree': 0.3, 'learning_rate': 0.1, 'n_estimators': 100, 'num_leaves': 70, 'reg_alpha': 1.4, 'reg_lambda': 1, 'subsample': 0.3}
0.9701522591853949
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># check the quality of calculation
</span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">rms</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_train_df</span><span class="p">,</span> <span class="n">grid_classification</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'rms = '</span><span class="p">,</span> <span class="n">rms</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="n">accur</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train_df</span><span class="p">,</span> <span class="n">grid_classification</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'accuracy = '</span><span class="p">,</span> <span class="n">accur</span><span class="p">)</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rms =  0.14208548895989545
accuracy =  0.9724708883551665


C:\Users\Leo\Anaconda3\lib\site-packages\sklearn\preprocessing\label.py:151: DeprecationWarning: The truth value of an empty array is ambiguous. Returning False, but in future this will result in an error. Use `array.size &gt; 0` to check that an array is not empty.
  if diff:
</code></pre></div></div>

<h3 id="predict-probability-of-1-of-making-a-purchase-probability-of-0-would-be-1---proba1">Predict probability of 1 (of making a purchase). probability of 0 would be (1 - proba[1])</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_df</span><span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_classification</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_classification</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_df</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="now-i-will-perform-the-regression-task-to-predict-the-revenue-first-for-each-visit-and-then-sum-up-these-predictions-to-predict-the-revenue-per-customer">Now I will perform the regression task to predict the revenue first for each visit, and then sum up these predictions to predict the revenue per customer.</h3>
<p>I will use the results of the classification task in two ways. First, I will use the new feature of ‘proba_prediction_train’ which predicts the probability of purchase for each row. Second, I will used this feature additionally to filter out the rows with very low probability of purchase. I do not know if such action will be useful, or what is the optimal cut off level for such filter, thus I will test several cut off levels and see if such treatment improves the score.</p>

<p>Similar to the classification task, I will employ the grid search for the regression task as well.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set params
</span><span class="n">params_regression</span> <span class="o">=</span> <span class="p">{</span><span class="s">"objective"</span> <span class="p">:</span> <span class="s">"regression"</span><span class="p">,</span>
        <span class="s">"metric"</span> <span class="p">:</span> <span class="s">"rmse"</span><span class="p">,</span>
        <span class="s">'max_depth'</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">'max_bin'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
        <span class="s">"min_child_samples"</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s">"bagging_fraction"</span> <span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="s">"feature_fraction"</span> <span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s">"bagging_frequency"</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">"bagging_seed"</span> <span class="p">:</span> <span class="mi">2018</span><span class="p">,</span>
        <span class="s">"verbosity"</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

<span class="c1"># Create parameters to search
</span><span class="n">gridParams_regression</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'learning_rate'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.10</span><span class="p">],</span> <span class="c1"># 0.15, 0.10
</span>    <span class="s">'n_estimators'</span><span class="p">:</span> <span class="p">[</span><span class="mi">70</span><span class="p">],</span>
    <span class="s">'num_leaves'</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">],</span>
    <span class="s">'colsample_bytree'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">],</span>
    <span class="s">'subsample'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">],</span>
    <span class="s">'reg_alpha'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">#[1,1.2, 1.4],
</span>    <span class="s">'reg_lambda'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">#[1,1.2,1.4]
</span>    <span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create classifier to use. Note that parameters have to be input manually
# not as a dict!
</span>
<span class="n">mdl_regression</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMRegressor</span><span class="p">(</span>
          <span class="n">objective</span> <span class="o">=</span> <span class="s">'regression'</span><span class="p">,</span>
          <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># Updated from 'nthread'
</span>          <span class="n">silent</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
          <span class="n">max_depth</span> <span class="o">=</span> <span class="n">params_regression</span><span class="p">[</span><span class="s">'max_depth'</span><span class="p">],</span>
          <span class="n">max_bin</span> <span class="o">=</span> <span class="n">params_regression</span><span class="p">[</span><span class="s">'max_bin'</span><span class="p">],</span>
          <span class="n">feature_fraction</span> <span class="o">=</span> <span class="n">params_regression</span><span class="p">[</span><span class="s">'feature_fraction'</span><span class="p">],</span>
          <span class="n">min_child_samples</span> <span class="o">=</span> <span class="n">params_regression</span><span class="p">[</span><span class="s">'min_child_samples'</span><span class="p">],</span>
          <span class="n">bagging_fraction</span> <span class="o">=</span> <span class="n">params_regression</span><span class="p">[</span><span class="s">'bagging_fraction'</span><span class="p">]</span>
          <span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cuot off levels for the probability of making a purchase
# 0.0 will indicate that no data will be cut off
</span><span class="n">probability_cutoff_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>

<span class="n">grid_regression</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">probability_cutoff</span> <span class="ow">in</span> <span class="n">probability_cutoff_list</span><span class="p">:</span>
    <span class="n">X_train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]</span><span class="o">&gt;</span><span class="n">probability_cutoff</span><span class="p">][</span><span class="n">cat_cols</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]]</span>
    <span class="n">y_train_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]</span><span class="o">&gt;</span><span class="n">probability_cutoff</span><span class="p">][</span><span class="s">"totals.transactionRevenue"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">test_df</span><span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]</span><span class="o">&gt;</span><span class="n">probability_cutoff</span><span class="p">][</span><span class="n">cat_cols</span> <span class="o">+</span> <span class="n">num_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s">'proba_prediction_train'</span><span class="p">]]</span>
    
    <span class="c1"># Create the grid search with 4 fold cross validation
</span>    <span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">mdl_regression</span><span class="p">,</span> <span class="n">gridParams_regression</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Run the grid
</span>    <span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">)</span>
    
    <span class="c1"># add results of grid search to the list of grid_regression
</span>    <span class="n">grid_regression</span> <span class="o">=</span> <span class="n">grid_regression</span> <span class="o">+</span> <span class="p">[</span><span class="n">grid</span><span class="p">]</span>

    <span class="c1"># Print the best parameters found
</span>    <span class="k">print</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'colsample_bytree': 0.3, 'learning_rate': 0.1, 'n_estimators': 70, 'num_leaves': 50, 'reg_alpha': 1, 'reg_lambda': 1, 'subsample': 0.3}
0.366094783813078
{'colsample_bytree': 0.3, 'learning_rate': 0.1, 'n_estimators': 70, 'num_leaves': 50, 'reg_alpha': 1, 'reg_lambda': 1, 'subsample': 0.3}
0.3433724709301465
{'colsample_bytree': 0.3, 'learning_rate': 0.1, 'n_estimators': 70, 'num_leaves': 50, 'reg_alpha': 1, 'reg_lambda': 1, 'subsample': 0.3}
0.335454834793921
{'colsample_bytree': 0.3, 'learning_rate': 0.1, 'n_estimators': 70, 'num_leaves': 50, 'reg_alpha': 1, 'reg_lambda': 1, 'subsample': 0.3}
0.33146897589710855
{'colsample_bytree': 0.3, 'learning_rate': 0.1, 'n_estimators': 70, 'num_leaves': 50, 'reg_alpha': 1, 'reg_lambda': 1, 'subsample': 0.3}
0.3310650060859367
</code></pre></div></div>

<h3 id="the-best-score-is-achieved-when-no-data-it-cut-off-in-other-words-removing-the-rows-with-low-predicted-probability-of-making-a-purchase-does-not-improve-out-predictions-still-it-was-an-interesting-option-to-test">The best score is achieved when no data it cut off. In other words, removing the rows with low predicted probability of making a purchase does not improve out predictions. Still, it was an interesting option to test.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># predict revenue for the test data used in the regression test. 
# Since the 0.0 cut off level gives the best results, the whole test set will be used.
</span><span class="n">X_test_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_regression</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># following lines are technically not necessary since I ended up using the 0.0 cut off level, but I'll still keep them.
</span><span class="n">test_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test_df</span><span class="p">[[</span><span class="s">'prediction'</span><span class="p">]]</span>

<span class="c1"># replace all the negative predictions with 0, as there can be no negative value
</span><span class="n">test_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="create-a-submission-file">Create a submission file</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load submission template file
</span><span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'sample_submission_v2.csv'</span><span class="p">)</span>
<span class="n">submission</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Leo\Anaconda3\lib\site-packages\IPython\core\interactiveshell.py:2785: DtypeWarning: Columns (0) have mixed types. Specify dtype option on import or set low_memory=False.
  interactivity=interactivity, compiler=compiler, result=result)
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fullVisitorId</th>
      <th>PredictedLogRevenue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0000018966949534117</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0000039738481224681</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0000073585230191399</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0000087588448856385</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0000149787903119437</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sub_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">"fullVisitorId"</span><span class="p">:</span><span class="n">test_id</span><span class="p">})</span>
<span class="n">sub_df</span><span class="p">[</span><span class="s">"PredictedLogRevenue"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">sub_df</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">"fullVisitorId"</span><span class="p">)[</span><span class="s">"PredictedLogRevenue"</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">sub_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">"fullVisitorId"</span><span class="p">,</span> <span class="s">"PredictedLogRevenue"</span><span class="p">]</span>
<span class="n">sub_df</span><span class="p">[</span><span class="s">"PredictedLogRevenue"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">sub_df</span><span class="p">[</span><span class="s">"PredictedLogRevenue"</span><span class="p">])</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d"</span><span class="p">)</span>
<span class="n">sub_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">"predict_revenues_"</span> <span class="o">+</span> <span class="n">now</span> <span class="o">+</span> <span class="s">".csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Finished'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Finished
</code></pre></div></div>

<h3 id="discussion">Discussion</h3>
<p>In this notebook, I successfully used the LGB classification and regression models to predict the future revenue for the users. There are number of additional methods we could use to improve prediction by our model.</p>
<ol>
  <li>Blending. Often model can be improved by blending the predictions by different approaches (SVM, linear regression, RNN, etc).</li>
  <li>In current approach, I did not take into consideration the chronology of the purchases. The model might perform better if we treat the data as a time series.</li>
  <li>During the classification step I predicted the probability of a revenue (yes or no without an actual value) for each row. Since in the final step of the process we are predicting the revenue for each user, not each row, we might get a better result if we predict the probabilities for users instead of the rows during the classification step.</li>
</ol>

      </div>
    </div>
    <div class="col-md-1"></div>
  </div>

  <div class="bigspacer"></div>
  <div class="spacer"></div>

</div>

  </div>

  <div id="footer">
    <nav class="navbar navbar-inverse text-center" role="navigation">
      <div class="spacer"></div>
      <div class="container">
        <ul class="nav navbar-nav footernav">
          <li>
            <span class="fa-stack fa-lg">
              <a href="https://www.facebook.com/PennDSG/">
                <i class="fa fa-facebook fa-stack-2x"></i>
              </a>
            </span>
            <span class="fa-stack fa-lg">
              <a href="https://www.linkedin.com/groups/8583138">
                <i class="fa fa-linkedin fa-stack-2x"></i>
              </a>
            </span>
            <span class="fa-stack fa-lg">
              <a href="https://join.slack.com/t/pdsg/signup">
                <i class="fa fa-slack fa-stack-2x"></i>
              </a>
            </span>
            <!-- <span class="fa-stack fa-lg"> -->
            <!--   <a href="https://github.com/penndsg"> -->
            <!--     <i class="fa fa-github-square fa-stack-2x"></i> -->
            <!--   </a> -->
            <!-- </span> -->
            <!-- <span class="fa-stack fa-lg"> -->
            <!--   <a href="https://www.youtube.com/channel/UCLsuOKhFp2lG21BTvWbcbeQ"> -->
            <!--     <i class="fa fa-youtube-square fa-stack-2x"></i> -->
            <!--   </a> -->
            <!-- </span> -->
          </li>
        </ul>
      </div>
      <div class="spacer"></div>
    </nav>
  </div>
</body>

<!-- Initialize the Smooth Scrolling function -->
<script>
  smoothScroll.init();
</script>

</html>
